<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  //localStorage.clear()
  $("#btn-stop").hide();
  $("#btn-reset").hide();

  // Variables globales
  var currentIssue;
  var currentWorklogs;

  // Funciones
  function connectToIssue() {
    var issueKey = $("#issue-key").val().trim();
    if (issueKey !== "") {
      google.script.run.withSuccessHandler(function(issueData) {
        currentIssue = JSON.parse(issueData);
        console.log(currentIssue)
        google.script.run.withSuccessHandler(function(issueWorklogData) {
            currentWorklogs = JSON.parse(issueWorklogData);
            refreshIssueData();
            console.log(currentWorklogs)
          }).getIssueWorklogs(issueKey);
      }).getIssue(issueKey);
    }
  }

  function refreshIssueData() {
    $("#issue-summary").text(currentIssue.summary);
    $("#total-hours-value").text((currentIssue.timeSpent/3600).toFixed(2) + "hs");
    $("#jira-link-value").attr("href", "https://craftech.atlassian.net/browse/" + currentIssue.key);
    refreshWorklogTable();
  }

  function refreshWorklogTable() {
    var tableBody = $("#worklogs-table-body");
    tableBody.empty();
    currentWorklogs.reverse()
    for (var i = 0; i < currentWorklogs.length; i++) {
      var worklog = currentWorklogs[i];
      var row = $("<tr>");
      $("<td>").text(moment(worklog.date).format("DD/MM/YY")).appendTo(row);
      $("<td>").text(moment(worklog.date).format("HH:mm")).appendTo(row);
      $("<td>").text(worklog.timeSpent).appendTo(row);
      $("<td>").text(worklog.comment).appendTo(row);
      $("<td>").text(worklog.author).appendTo(row);
      tableBody.append(row);
    }
  }

function redondearHaciaArriba(numSegundos) {
  const multiplo300 = Math.floor(numSegundos / 300) * 300; // Obtener m√∫ltiplo de 300 menor o igual a numSegundos
  return multiplo300 < numSegundos ? multiplo300 + 300 : multiplo300; // Agregar 300 si es necesario
}


// Variables globales
var startTime = null;
var timerDuration = 0;
var timerInterval = null;
var timerRunning = false;
var currentTimer = 0;


// Funciones


function updateTimer() {
  currentTimer++;
  console.log(currentTimer)
  var duration = moment.duration(currentTimer, 'seconds');
  var formattedDuration = duration.humanize();
  $('#cronometro').text(formattedDuration);
}





function startTimer() {
  if (!timerRunning) {
    startTime = moment();
    timerInterval = setInterval(updateTimer, 1000);
    timerRunning = true;
    $("#btn-play").hide();
    $("#btn-stop").show();
    $("#btn-reset").show();
  }
}


function pauseTimer() {
  if (timerRunning) {
    clearInterval(timerInterval);
    timerInterval = null;
    timerRunning = false;
    $("#btn-play").show();
    $("#btn-pause").hide();
  }
}

function stopTimer() {
  pauseTimer();
  timerDuration = moment.duration(0);
  timerRunning = false;
  $("#cronometro").text(timerDuration.humanize());
  $("#btn-stop").hide();
  $("#btn-play").text("Resume");
  $("#btn-play").show();
}

function resetTimer() {
  pauseTimer();
  timerDuration = moment.duration(0);
  currentTimer = 0
  timerRunning = false;
  startTime = moment();
  $("#cronometro").text(0);
  $("#btn-stop").hide();
  $("#btn-reset").hide();
  $("#btn-play").text("Start");
  $("#btn-play").show();
}

function sendWorklog(){
  if($("#worklog-comment").val()!=""){
    google.script.run.withSuccessHandler(function (response) {
      console.log(response)
      resetTimer()
      $("#cronometro").text(0);
      connectToIssue()
    }).setIssueWorklog(currentIssue.key,redondearHaciaArriba(currentTimer),$("#worklog-comment").val(),startTime.toISOString().replace("Z", "-0000"));
    $("#worklog-comment").val("");

  }else{
    console.log("NO SE PUEDE ENVIAR UN WORKLOG SIN COMENTARIOS")
  }
}


// Eventos
$("#btn-play").click(startTimer);
$("#btn-pause").click(pauseTimer);
$("#btn-stop").click(stopTimer);
$("#btn-reset").click(resetTimer);
$("#btn-finish").click(sendWorklog);




// Eventos
$("#connect-btn").click(function(event) {
  event.preventDefault();
  connectToIssue();
});


</script>