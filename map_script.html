<script>

  var issues = null;
  var selectedProject = null;
  var personalStringMAP = null;


  function updateJiraData(){
    $("#progressBar").show()
    google.script.run.withSuccessHandler(function(response){
      localStorage.setItem("issues",response)
      issues = JSON.parse(response)
      updateData()
      updateSquadInputOptions()
      $("#progressBar").hide()

    }).withFailureHandler(function(error){
      $("#progressBar").hide()
      M.toast({html: 'Error al cargar los issues, revisa tu token o refresca la pagina'})
      console.log("ERROR AL CARGAR LOS ISSUES")
      console.log(error)

    }).retrieveJiraIssuesString()
  }




  function updateSquadInputOptions(){
    var issuesLocal = issues.map((item)=>{
      return item.squadId
    })
    issuesLocal = removeDups(issuesLocal).sort()
    $("#squadId").empty()
    $("#squadId").append($('<option>', {
      value: "Select",
      text: "Select"
    }));
    issuesLocal.forEach((item)=>{
      $("#squadId").append($("<option>", {
        value: item,
        text: item
      }));
    })
  }


  function removeDups(list) {
    let unique = {};
    list.forEach(function(i) {
      if(!unique[i]) {
        unique[i] = true;
      }
    });
    return Object.keys(unique);
  }


  function removeDuplicates(data, key = 'id') {
    const seen = new Map();
    return data.filter(item => {
      const val = item[key];
      if (seen.has(val)) {
        return false;
      } else {
        seen.set(val, true);
        return true;
      }
    });
  }


  // Filtrar los issues según los valores de los inputs correspondientes
  function updateData() {
    var squadId = $("#squadId").val();
    var searchText = $("#searchIssue").val();
    var filteredIssues = issues;
    if (squadId != "Select") {
      filteredIssues = filteredIssues.filter(function(item) {
        return item.squadId == squadId;
      });
    }
    if (searchText) {
      filteredIssues = filteredIssues.filter(function(item) {
        return item.project.toLowerCase().includes(searchText.toLowerCase());
      });
    }
    // Actualizar la tabla de issues con los resultados del filtro
    updateIssuesTable(filteredIssues);
  }



  function updateIssuesTable(filteredIssues) {
    const tableBody = $("#issuesTable tbody");
    tableBody.empty();
    if ( filteredIssues.length==0 || filteredIssues.length==null ){
      console.log("ERROR AL OBTENER LOS ISSUES DE JIRA")
      $("#progressBar").hide()
    }
    var projectsList = removeDuplicates(filteredIssues,"project")
    projectsList.forEach(issue => {
      var arrayOfSprintName = issue.sprint.name.split(" ")
      var sprintDateString = arrayOfSprintName[arrayOfSprintName.length-1]
      const row = $(`<tr class="issue-row" projectId="${issue.projectId}" projectName="${issue.project}" sprintDateString="${sprintDateString}" sprintId="${issue.sprint.id}"></tr>`); // sprintId
      const projectCol = $("<td></td>").text(issue.project);
      const squadCol = $("<td></td>").text(issue.squadId);
      const sprintCol = $("<td></td>").text(issue.sprint.name);
      row.append(projectCol, squadCol,sprintCol);
      tableBody.append(row);
    });
  }




/** ###############################################*/
/** ############# AL CARGAR LA PAGINA #############*/
/** ###############################################*/
$(document).ready(function() {
    $("#squadId").append($("<option>", {
    value: "Select",
    text: "Select"
  }));


  //Inicializo el valor de personal string for meetings and planning
  if(personalStringMAP==null){
    if(localStorage.getItem("personalStringMAP")==null||localStorage.getItem("personalStringMAP")==undefined){
      personalStringMAP= "Meetings and Planning"
    }else{
      personalStringMAP= localStorage.getItem("personalStringMAP")
    }
  }
  $("#stringAux").val(personalStringMAP)



  //Inicializo el valor de los issues de jira
  let auxStored = localStorage.getItem("issues")
  if(auxStored!=null || auxStored!=undefined){
    try{
      issues = JSON.parse(localStorage.getItem("issues"))
      updateData();
      updateSquadInputOptions()
    }catch(e){
      console.log(e)
    }
  }




  // Manejo de triggers
  $("#squadId").on("change", function() {
    var squadId = $(this).val();
    updateData();
  });

  $("#searchIssue").on("input", function() {
    updateData();
  });

  $("#stringAux").on("input", function() {
    personalStringMAP = $("#stringAux").val()
    selectedProject.string = selectedProject.projectName + " - " + personalStringMAP + " - " + selectedProject.sprintDateString
    $("#selectedProject").val(selectedProject.string);
    localStorage.setItem("personalStringMAP",personalStringMAP)
  });

  

  $(document).on("click", ".issue-row", function() {
    // Guardar una referencia al evento seleccionado en una variable global
    selectedProject = {
      projectName: $(this).attr("projectName"),
      projectId: $(this).attr("projectId"),
      sprintDateString: $(this).attr("sprintDateString"),
      sprintId: $(this).attr("sprintId")
    };
    selectedProject.string = selectedProject.projectName + " - " + personalStringMAP + " - " + selectedProject.sprintDateString

    
    // Actualizar los valores de los campos de entrada
    $("#selectedProject").val(selectedProject.string);
    
    // Cambiar el estilo de la fila seleccionada
    $(".issue-row").removeClass("selected");
    $(this).addClass("selected");
  });






/**CREAR ISSUE MAP*/

  // Envío de worklog
  $("#syncButton").on("click", function() {
    var sprintIdAux = parseInt(selectedProject.sprintId, 10)
    var responseData
    
    var data = {
      "fields": {
        "project": {
          "id": selectedProject.projectId
        },
        "summary": selectedProject.string,
        "issuetype": {
          "id": "10005"
        },
        "customfield_10026": 0,
      }
    }
    data.fields["customfield_10020"] = sprintIdAux
    google.script.run.withSuccessHandler(function(response){
      responseData = JSON.parse(response)
      console.log(responseData)
      $(".issue-row").removeClass("selected");
      M.toast({html: 'Nuevo Issue Creado'})
    }).newIssue(data)


    });


});


</script>